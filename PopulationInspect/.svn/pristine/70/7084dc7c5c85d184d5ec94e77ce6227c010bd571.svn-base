package edu.hdu.lab.checkIn.controllers;

import java.io.File;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.HashMap;
import java.util.Map;

import javax.servlet.http.HttpServletRequest;

import org.apache.log4j.Logger;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.multipart.commons.CommonsMultipartFile;

import edu.hdu.lab.checkIn.mapper.PersonMapper;
import edu.hdu.lab.checkIn.model.Person;
import edu.hdu.lab.checkIn.utils.Constants;
import edu.hdu.lab.checkIn.utils.JsonUtils;
import edu.hdu.lab.checkIn.utils.WebUtils;

@Controller
@RequestMapping("/person")
public class PersonController {

	private Logger logger = Logger.getLogger(getClass());

	@Autowired
	private PersonMapper personMapper;

	/**
	 * 根据人员的ID 获取详细信息
	 * 
	 * @param pers_id
	 *            人员ID
	 * @param request
	 * @return
	 */
	@ResponseBody
	@RequestMapping(value = "/info", method = RequestMethod.POST, produces = "text/html;charset=UTF-8")
	public String getPersonInfobyPersId(
			@RequestParam("pers_id") Integer pers_id, HttpServletRequest request) {
		Person person = personMapper.selectByPrimaryKey(pers_id);
		int resultCode = 0;
		Map<String, Object> resultMap = new HashMap<String, Object>(2);
		if (person != null) {
			resultCode = 1;
			resultMap.put("person", person);
		}
		resultMap.put("resultCode", resultCode);
		return JsonUtils.createGson().toJson(resultMap);
	}

	/**
	 * 添加人员信息
	 * 
	 * @param addrCensus
	 * @param addrLive
	 * @param addrWork
	 * @param isDeleted
	 * @param isFocus
	 * @param persIdcard
	 * @param persName
	 * @param persPhone
	 * @param persPhoto
	 * @param persSex
	 * @param ramark
	 * @param roomId
	 * @param timeRegister
	 * @param whyRegister
	 * @param request
	 * @return
	 */
	@ResponseBody
	@RequestMapping(value = "/add.do", method = RequestMethod.POST, produces = "text/html;charset=UTF-8")
	public String addPerson(
			@RequestParam(value = "addrCensus", required = false) String addrCensus,
			@RequestParam(value = "addrLive", required = false) String addrLive,
			@RequestParam(value = "addrWork", required = false) String addrWork,
			@RequestParam(value = "isDeleted", required = false) Boolean isDeleted,
			@RequestParam(value = "isFocus", required = false) Boolean isFocus,
			@RequestParam(value = "persIdcard", required = false) String persIdcard,
			@RequestParam(value = "persName", required = false) String persName,
			@RequestParam(value = "persPhone", required = false) String persPhone,
			@RequestParam(value = "persPhoto", required = false) CommonsMultipartFile pictureOneFile,
			@RequestParam(value = "persSex", required = false) Boolean persSex,
			@RequestParam(value = "ramark", required = false) String ramark,
			@RequestParam(value = "roomId", required = true) Integer roomId,
			@RequestParam(value = "timeRegister", required = false) String timeRegister,
			@RequestParam(value = "whyRegister", required = false) String whyRegister,
			@RequestParam(value = "callback", required = false) String callback,
			HttpServletRequest request) {
		Person person = new Person();
		person.setAddrCensus(addrCensus);
		person.setAddrLive(addrLive);
		person.setAddrWork(addrWork);
		person.setIsDeleted(isDeleted);
		person.setIsFocus(isFocus);
		person.setPersIdcard(persIdcard);
		person.setPersName(persName);
		person.setPersPhone(persPhone);
		// person.setPersPhoto(persPhoto);
		person.setPersSex(persSex);
		person.setRamark(ramark);
		person.setRoomId(roomId);
		if (timeRegister != null) {
			try {
				person.setTimeRegister(new SimpleDateFormat(
						"yyyy-MM-dd HH:mm:ss").parse(timeRegister));
			} catch (ParseException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			}
		}
		person.setWhyRegister(whyRegister);
		if (pictureOneFile != null) {
			String filesLocation = Constants.STATIC_FILES_PATH;
			File dirFile = new File(filesLocation);
			if (!WebUtils.checkDirAvailabilityAndCreate(dirFile))
				return WebUtils.produceResult(callback,
						Constants.RESULT_CODE_DIR_CREATION_FAILED);
			String pictureOneFileName = WebUtils.fileIsEmpty(pictureOneFile) ? null
					: WebUtils.saveFile(pictureOneFile, filesLocation,
							Constants.FILE_TYPE_IMAGE);
			person.setPersPhoto(pictureOneFileName);
		}
		//int resultCode = 0;
		Map<String, Object> resultMap = new HashMap<String, Object>(2);
		int resultCode = personMapper.insertSelective(person);
		//resultMap.put("resultCode", resultCode);

        return WebUtils.produceResult(callback, resultCode);
	}
	
	@ResponseBody
	@RequestMapping(value = "/edit.do", method = RequestMethod.POST, produces = "text/html;charset=UTF-8")
	public String updateUser(
			@RequestParam("persId") Integer persId,
			@RequestParam(value = "addrCensus", required = false) String addrCensus,
			@RequestParam(value = "addrLive", required = false) String addrLive,
			@RequestParam(value = "addrWork", required = false) String addrWork,
			@RequestParam(value = "isDeleted", required = false) Boolean isDeleted,
			@RequestParam(value = "isFocus", required = false) Boolean isFocus,
			@RequestParam(value = "persIdcard", required = false) String persIdcard,
			@RequestParam(value = "persName", required = false) String persName,
			@RequestParam(value = "persPhone", required = false) String persPhone,
			@RequestParam(value = "persPhoto", required = false) CommonsMultipartFile persPhoto,
			@RequestParam(value = "persSex", required = false) Boolean persSex,
			@RequestParam(value = "ramark", required = false) String ramark,
			@RequestParam(value = "roomId", required = true) Integer roomId,
			@RequestParam(value = "timeRegister", required = false) String timeRegister,
			@RequestParam(value = "whyRegister", required = false) String whyRegister,
			@RequestParam(value = "callback", required = false) String callback,
			HttpServletRequest request) {
		Person pers = new Person();
		pers.setPersId(persId);
		pers.setRoomId(roomId);
		pers.setPersName(persName);
		pers.setAddrCensus(addrCensus);
		pers.setAddrLive(addrLive);
		pers.setAddrWork(addrWork);
		pers.setIsFocus(isFocus);
		pers.setIsDeleted(isDeleted);
		pers.setPersIdcard(persIdcard);
		pers.setPersPhone(persPhone);
		pers.setPersSex(persSex);
		pers.setWhyRegister(whyRegister);
		if (timeRegister != null) {
			try {
				pers.setTimeRegister(new SimpleDateFormat(
						"yyyy-MM-dd HH:mm:ss").parse(timeRegister));
			} catch (ParseException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			}
		}
		String filesLocation = Constants.STATIC_FILES_PATH;
        File dirFile = new File(filesLocation);
        if (!WebUtils.checkDirAvailabilityAndCreate(dirFile))
            return WebUtils.produceResult(callback, Constants.RESULT_CODE_DIR_CREATION_FAILED);

        String iconFileNewName = WebUtils.fileIsEmpty(persPhoto) ? null : WebUtils.saveFile(persPhoto, filesLocation, Constants.FILE_TYPE_IMAGE);
        
        pers.setPersPhoto(iconFileNewName);        
        int resultCode = personMapper.updateByPrimaryKeySelective(pers);
        
        return WebUtils.produceResult(callback, resultCode);

	}

}
