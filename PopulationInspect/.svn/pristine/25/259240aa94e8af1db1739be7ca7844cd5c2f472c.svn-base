package com.example.project;

import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import com.example.DButil.DBMannger;
import com.example.DButil.MySqliteHelper;
import com.example.Http.GetTaskThread;
import com.example.Http.PostLogThread;

import android.database.Cursor;
import android.database.sqlite.SQLiteDatabase;
import android.os.Bundle;
import android.support.v4.app.ListFragment;
import android.view.LayoutInflater;
import android.view.View;
import android.view.ViewGroup;
import android.view.View.OnClickListener;
import android.widget.Button;
import android.widget.ListView;
import android.widget.SimpleAdapter;
import android.widget.Toast;

public class MyFragment03 extends ListFragment{
	
	private ListView mListView;
	private SimpleAdapter sim_adapter;
	private Button getTask;					//获取任务
	
	//数据库
	private MySqliteHelper helper;
	
	@Override
	public View onCreateView(LayoutInflater inflater, ViewGroup container,
			Bundle savedInstanceState) {
		// TODO Auto-generated method stub
		View view = inflater.inflate(R.layout.tab03, container, false);  
		
		//初始化控件
		mListView = (ListView) view.findViewById(android.R.id.list);  
		getTask = (Button) view.findViewById(R.id.getTask);
		
		//设置控件的点击事件
		initView();
		return view;
	}
	
	//设置控件的点击事件
	private void initView() {
		getTask.setOnClickListener(new OnClickListener() {		
			@Override
			public void onClick(View arg0) {
				new GetTaskThread("http://10.0.5.199:8080/PopulationInspect/task/Task_list",getActivity()).start();
				//updateData();
				Toast.makeText(getActivity(), "数据已更新", Toast.LENGTH_SHORT ).show();	
			}
		});
	}
	
	@Override
	public void onCreate(Bundle savedInstanceState) {
		// TODO Auto-generated method stub
		super.onCreate(savedInstanceState);
		
		initDBMannger(); 		//初始化数据库管理
        updateData();			//从数据库查询日志信息
	}
	
	//初始化数据库管理
	private void initDBMannger() {
		helper = DBMannger.getIntance(getActivity());
		//创建数据�?
		SQLiteDatabase db = helper.getWritableDatabase();
	}
	
	//从数据库查询日志信息
	public void updateData() {
		sim_adapter = new SimpleAdapter(getActivity(), getData(), R.layout.taskitem, new String[]{"task_community","task_room","task_pic","task_date"}, new int[]{R.id.community, R.id.room, R.id.task_pic, R.id.task_date});
        setListAdapter(sim_adapter);  
	}
	//获取日志列表数据
	private List<Map<String,Object>> getData(){
		List<Map<String,Object>> dataList = new ArrayList<Map<String,Object>>();
		
		SQLiteDatabase db = helper.getWritableDatabase();
    	String sql;
	
		sql = "select * from task_t";					
		Cursor c = db.rawQuery(sql,null);
		if(c != null){
			String[] cols = c.getColumnNames();		//id,content,date
			while(c.moveToNext()){
				Map<String,Object> map = new HashMap<String, Object>();
				map.put("task_id", c.getString(c.getColumnIndex("id")));
				map.put("task_pic", R.drawable.task);
				map.put("task_longitude", c.getString(c.getColumnIndex("longitude")));
	    		map.put("task_latitude", c.getString(c.getColumnIndex("latitude")));
	    		map.put("task_date", c.getString(c.getColumnIndex("deadLine")));
	    		map.put("task_community", c.getString(c.getColumnIndex("community")));
	    		map.put("task_room", c.getString(c.getColumnIndex("room")));
	    		dataList.add(map);
			}
		}
		db.close();

    	return dataList;
    }
	
	//列表条目点击事件
	@Override
	public void onListItemClick(ListView l, View v, int position, long id) {
		// TODO Auto-generated method stub
		String text = mListView.getItemAtPosition(position)+"";
		Toast.makeText(getActivity(), text, Toast.LENGTH_SHORT ).show();
	}
}